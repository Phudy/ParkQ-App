<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFD600">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Park-Q | Intelligent Parking</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #0A0A0A; font-family: 'Prompt', sans-serif; -webkit-tap-highlight-color: transparent; }
        .view { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .view.active { display: flex; opacity: 1; }
        
        /* Loading Screen (Inline for safety) */
        #loading-view {
            position: fixed; inset: 0; z-index: 9999;
            background-color: #0A0A0A; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Error Screen */
        #critical-error {
            display: none; position: fixed; inset: 0; z-index: 10000;
            background-color: #7f1d1d; color: white;
            flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }

        /* In-App Browser Warning */
        #in-app-warning {
            display: none; position: fixed; top: 0; left: 0; width: 100%;
            background: #FFD600; color: #000; padding: 12px; z-index: 9998;
            font-size: 14px; font-weight: bold; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col fixed inset-0 w-full h-full bg-black">

    <!-- 1. IN-APP BROWSER WARNING -->
    <div id="in-app-warning">
        <i class="fas fa-exclamation-triangle"></i> เพื่อการใช้งานที่สมบูรณ์ กรุณากดปุ่ม 3 จุดด้านบน แล้วเลือก <strong>"เปิดในเบราว์เซอร์"</strong>
    </div>

    <!-- 2. GLOBAL ERROR UI -->
    <div id="critical-error">
        <i class="fas fa-bug text-5xl mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">เกิดข้อผิดพลาด</h2>
        <p id="error-text" class="text-sm font-mono bg-black/30 p-4 rounded mb-6 break-all">Unknown Error</p>
        <button onclick="window.location.reload()" class="bg-white text-red-900 px-6 py-2 rounded-full font-bold">ลองใหม่</button>
    </div>

    <!-- 3. TOAST -->
    <div id="toast" class="fixed top-12 left-1/2 -translate-x-1/2 z-[100] transition-all duration-300 transform -translate-y-32 opacity-0 flex items-center gap-3 px-5 py-3 rounded-full shadow-2xl bg-gray-800 text-white min-w-[200px] justify-center border border-gray-700">
        <i class="fas fa-info-circle text-[#FFD600]"></i>
        <span id="toast-msg" class="font-medium text-sm">Notification</span>
    </div>

    <!-- 4. SPLASH SCREEN (Fail-Safe) -->
    <div id="loading-view">
        <div class="w-20 h-20 bg-[#FFD600] rounded-2xl flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(255,214,0,0.4)] animate-bounce">
            <i class="fas fa-car-side text-4xl text-black"></i>
        </div>
        <h1 class="text-3xl font-bold tracking-widest mb-2">Park<span style="color: #FFD600;">Q</span></h1>
        <p class="text-gray-400 text-xs tracking-wide animate-pulse">กำลังเชื่อมต่อระบบ...</p>
        <div id="loading-log" class="mt-4 text-[10px] text-gray-600 font-mono h-4">Initializing...</div>
        <button onclick="forceStart()" class="absolute bottom-10 text-gray-600 text-xs underline">Skip Loading (Emergency)</button>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="app-root" class="flex-grow w-full bg-white min-h-screen relative overflow-y-auto hidden text-black">
        
        <!-- VIEW: LOGIN -->
        <div id="login-view" class="view flex-col h-full bg-white relative">
            <div class="h-1/3 w-full flex flex-col justify-end px-8 pb-10 bg-[#FFD600]">
                <h1 class="text-4xl font-bold text-black mb-2">Park-Q</h1>
                <p class="text-black opacity-80">จัดการที่จอดรถของคุณ</p>
            </div>
            <div class="p-8 space-y-6">
                <input type="email" id="email" class="w-full p-4 bg-gray-100 rounded-xl text-black border-2 border-transparent focus:border-[#FFD600] outline-none transition" placeholder="Email">
                <input type="password" id="password" class="w-full p-4 bg-gray-100 rounded-xl text-black border-2 border-transparent focus:border-[#FFD600] outline-none transition" placeholder="Password">
                
                <button id="auth-btn" class="w-full bg-black text-white font-bold p-4 rounded-xl shadow-lg active:scale-95 transition">เข้าสู่ระบบ</button>
                
                <div class="text-center text-gray-400 text-sm">หรือ</div>
                
                <button id="google-btn" class="w-full border-2 border-gray-200 text-gray-600 font-bold p-3 rounded-xl flex justify-center items-center gap-2 active:scale-95 transition">
                    <i class="fab fa-google text-red-500"></i> Google Login
                </button>
                
                <p class="text-center text-gray-500 text-sm mt-4">
                    <span id="toggle-auth" class="underline cursor-pointer hover:text-[#FFD600]">สมัครสมาชิกใหม่</span>
                </p>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="dashboard-view" class="view flex-col h-full bg-gray-50">
            <div class="bg-white p-6 pb-4 rounded-b-3xl shadow-sm flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-[#FFD600] rounded-full flex items-center justify-center text-black font-bold"><i class="fas fa-user"></i></div>
                    <div>
                        <h2 class="text-black font-bold text-lg leading-none" id="user-display">User</h2>
                        <p class="text-gray-400 text-xs">Park-Q Member</p>
                    </div>
                </div>
                <button id="logout-btn" class="text-gray-400 hover:text-red-500"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-6 pb-24">
                <!-- Status Card -->
                <div class="bg-black text-white rounded-3xl p-6 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-[#FFD600] rounded-full blur-[50px] opacity-20"></div>
                    
                    <!-- Empty State -->
                    <div id="status-empty" class="text-center py-6">
                        <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-map-marker-alt text-2xl text-[#FFD600]"></i></div>
                        <h3 class="text-xl font-bold mb-1">ยังไม่ระบุที่จอด</h3>
                        <p class="text-gray-400 text-sm mb-6">กดปุ่มด้านล่างเพื่อบันทึก</p>
                        <button id="snap-btn" class="bg-[#FFD600] text-black w-full py-3 rounded-xl font-bold shadow-lg hover:bg-white transition active:scale-95">Snap & Park</button>
                    </div>

                    <!-- Parked State -->
                    <div id="status-parked" class="hidden">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs text-[#FFD600] font-bold tracking-widest">PARKED AT</p>
                                <h2 class="text-2xl font-bold" id="disp-loc">...</h2>
                            </div>
                            <span class="bg-green-500/20 text-green-400 px-2 py-1 rounded text-xs font-bold">ACTIVE</span>
                        </div>
                        <div class="flex gap-4 mb-6">
                            <div class="bg-white/10 p-3 rounded-xl flex-1 text-center border border-white/10">
                                <span class="text-xs text-gray-400 block">FLOOR</span>
                                <span class="text-xl font-bold" id="disp-floor">-</span>
                            </div>
                            <div class="bg-white/10 p-3 rounded-xl flex-1 text-center border border-white/10">
                                <span class="text-xs text-gray-400 block">ZONE</span>
                                <span class="text-xl font-bold" id="disp-zone">-</span>
                            </div>
                        </div>
                        <button id="checkout-btn" class="w-full border border-white/20 py-3 rounded-xl text-sm font-bold hover:bg-white/10 transition">เอารถออก</button>
                    </div>
                </div>

                <!-- Cars -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-black font-bold">รถของฉัน</h3>
                        <button id="add-car-btn" class="bg-black text-white text-xs px-3 py-1 rounded-full">+ เพิ่ม</button>
                    </div>
                    <div id="car-list" class="space-y-3">
                        <div class="text-center text-gray-400 py-4 text-sm">กำลังโหลดข้อมูล...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: CONTACT -->
        <div id="contact-view" class="view flex-col h-full bg-[#111] text-white">
            <div class="p-10 text-center">
                <div class="w-20 h-20 mx-auto bg-gray-800 rounded-full flex items-center justify-center border-2 border-[#FFD600] mb-4">
                    <i class="fas fa-shield-alt text-3xl text-[#FFD600]"></i>
                </div>
                <h1 class="text-2xl font-bold">ติดต่อเจ้าของรถ</h1>
                <p class="text-gray-500 text-sm mt-2">ทะเบียน: <span id="contact-plate" class="text-white font-bold">...</span></p>
            </div>
            <div class="px-6 space-y-4">
                <button onclick="alert('จำลอง: กำลังต่อสายแบบไม่โชว์เบอร์...')" class="w-full bg-gradient-to-r from-red-600 to-red-800 p-5 rounded-2xl flex items-center gap-4 shadow-lg active:scale-95 transition">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-phone"></i></div>
                    <div class="text-left"><div class="font-bold text-lg">โทรฉุกเฉิน</div><div class="text-xs opacity-80">จอดขวาง / เร่งด่วน</div></div>
                </button>
                <button onclick="alert('จำลอง: ส่งรูปภาพแจ้งเตือนแล้ว')" class="w-full bg-gradient-to-r from-orange-500 to-yellow-500 p-5 rounded-2xl flex items-center gap-4 shadow-lg active:scale-95 transition">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-camera"></i></div>
                    <div class="text-left"><div class="font-bold text-lg">แจ้งเตือน</div><div class="text-xs opacity-80">ลืมปิดไฟ / หน้าต่าง</div></div>
                </button>
            </div>
        </div>

        <!-- QR MODAL -->
        <div id="qr-modal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-6">
            <div class="bg-white p-6 rounded-3xl w-full max-w-sm text-center">
                <h2 class="text-xl font-bold mb-1 text-black">QR Code</h2>
                <p class="text-gray-400 text-sm mb-4" id="qr-car-name">...</p>
                <div class="bg-[#FFD600] p-1 rounded-2xl inline-block mb-4">
                    <div class="bg-white p-3 rounded-xl">
                        <div id="qrcode-display"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <button id="simulate-scan-btn" class="w-full bg-black text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                        <i class="fas fa-eye"></i> จำลองมุมมองคนสแกน
                    </button>
                    <button id="close-modal-btn" class="bg-gray-100 text-black w-full py-3 rounded-xl font-bold">ปิด</button>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- ERROR TRAP ---
        window.onerror = function(msg, src, line, col, error) {
            document.getElementById('loading-view').style.display = 'none';
            document.getElementById('critical-error').style.display = 'flex';
            document.getElementById('error-text').innerText = `${msg}\nLine: ${line}`;
            return false;
        };
        
        window.onunhandledrejection = function(event) {
            document.getElementById('loading-view').style.display = 'none';
            document.getElementById('critical-error').style.display = 'flex';
            document.getElementById('error-text').innerText = "Promise Error: " + event.reason;
        };

        // --- LOG HELPER ---
        const logStatus = (msg) => {
            console.log(msg);
            const el = document.getElementById('loading-log');
            if(el) el.innerText = msg;
        };

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB2vFDc5YjDMlDpkzquE57q2inbFqhO8zA",
            authDomain: "parkq-1ad8f.firebaseapp.com",
            projectId: "parkq-1ad8f",
            storageBucket: "parkq-1ad8f.firebasestorage.app",
            messagingSenderId: "861135790012",
            appId: "1:861135790012:web:6d527805dac14909dc15b9",
            measurementId: "G-BQM13JK9PG"
        };

        let auth, db, user;

        // --- GLOBAL HELPERS ---
        window.forceStart = () => {
            document.getElementById('loading-view').style.display = 'none';
            document.getElementById('app-root').classList.remove('hidden');
            showView('login-view');
        };

        function showView(id) {
            document.querySelectorAll('.view').forEach(e => e.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
        }

        function showToast(msg, isError=false) {
            const t = document.getElementById('toast');
            t.querySelector('span').innerText = msg;
            t.classList.remove('opacity-0', '-translate-y-32');
            if(isError) t.classList.add('bg-red-900');
            else t.classList.remove('bg-red-900');
            setTimeout(() => t.classList.add('opacity-0', '-translate-y-32'), 3000);
        }

        // --- INIT ---
        async function init() {
            // 1. Check UA for LINE
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            if ((ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Line") > -1)) {
                document.getElementById('in-app-warning').style.display = 'block';
                logStatus("In-App Browser Detected");
            }

            // 2. Firebase Init
            try {
                logStatus("Connecting to Firebase...");
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                logStatus("Firebase Connected");

                // 3. Router Check
                const checkRoute = () => {
                    const hash = window.location.hash;
                    if(hash.includes('#contact')) {
                        const p = new URLSearchParams(hash.split('?')[1]);
                        const oid = p.get('ownerId');
                        const cid = p.get('carId');
                        
                        document.getElementById('loading-view').style.display = 'none';
                        document.getElementById('app-root').classList.remove('hidden');
                        showView('contact-view');
                        
                        if(oid && cid) {
                            getDoc(doc(db, `artifacts/park-q-default/users/${oid}/cars/${cid}`)).then(s => {
                                if(s.exists()) document.getElementById('contact-plate').innerText = s.data().plate;
                            }).catch(err => console.error("Car fetch error", err));
                        }
                        return true; // Handled
                    }
                    return false; // Not handled
                };

                // 4. Auth State
                logStatus("Checking Auth...");
                onAuthStateChanged(auth, (u) => {
                    document.getElementById('loading-view').style.display = 'none';
                    document.getElementById('app-root').classList.remove('hidden');
                    
                    if (checkRoute()) return; // Priority to contact view

                    if (u) {
                        user = u;
                        document.getElementById('user-display').innerText = u.email.split('@')[0];
                        showView('dashboard-view');
                        setupDashboard();
                    } else {
                        showView('login-view');
                    }
                });

            } catch (e) {
                throw new Error("Init Failed: " + e.message);
            }
        }

        // --- DASHBOARD ---
        function setupDashboard() {
            const userId = user.uid;
            // Listen to parking
            onSnapshot(doc(db, `artifacts/park-q-default/users/${userId}/parkingStatus/current`), (doc) => {
                if(doc.exists()) {
                    const d = doc.data();
                    document.getElementById('status-empty').classList.add('hidden');
                    document.getElementById('status-parked').classList.remove('hidden');
                    document.getElementById('disp-loc').innerText = d.location || 'Unknown';
                    document.getElementById('disp-floor').innerText = d.floor || '-';
                    document.getElementById('disp-zone').innerText = d.pillar || '-';
                } else {
                    document.getElementById('status-empty').classList.remove('hidden');
                    document.getElementById('status-parked').classList.add('hidden');
                }
            });

            // Listen to cars
            const q = query(collection(db, `artifacts/park-q-default/users/${userId}/cars`));
            onSnapshot(q, (sn) => {
                const list = document.getElementById('car-list');
                list.innerHTML = '';
                if(sn.empty) list.innerHTML = '<div class="text-center text-gray-400 text-sm">ยังไม่มีรถ</div>';
                
                sn.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-100";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center"><i class="fas fa-car"></i></div>
                            <div><div class="font-bold text-black">${c.name}</div><div class="text-xs text-gray-500">${c.plate}</div></div>
                        </div>
                        <button class="qr-btn text-gray-400" data-id="${d.id}" data-name="${c.name}"><i class="fas fa-qrcode text-xl"></i></button>
                    `;
                    list.appendChild(div);
                });

                document.querySelectorAll('.qr-btn').forEach(btn => {
                    btn.onclick = () => {
                        const id = btn.dataset.id;
                        const name = btn.dataset.name;
                        const modal = document.getElementById('qr-modal');
                        const display = document.getElementById('qrcode-display');
                        display.innerHTML = '';
                        
                        // สร้าง URL สำหรับ QR Code (ใช้ URL ปัจจุบัน + Hash)
                        const currentUrl = window.location.href.split('#')[0];
                        const fullUrl = `${currentUrl}#contact?ownerId=${userId}&carId=${id}`;
                        
                        new QRCode(display, { text: fullUrl, width: 180, height: 180 });
                        document.getElementById('qr-car-name').innerText = name;
                        
                        // ผูกปุ่มจำลอง
                        document.getElementById('simulate-scan-btn').onclick = () => {
                            modal.classList.add('hidden');
                            window.location.hash = `#contact?ownerId=${userId}&carId=${id}`;
                            window.location.reload(); // Reload to trigger router fresh
                        };
                        
                        modal.classList.remove('hidden');
                    };
                });
            });
        }

        // --- HANDLERS ---
        let isReg = false;
        document.getElementById('toggle-auth').onclick = () => {
            isReg = !isReg;
            const btn = document.getElementById('auth-btn');
            const link = document.getElementById('toggle-auth');
            if(isReg) { btn.innerText = "สมัครสมาชิก"; link.innerText = "มีบัญชีแล้ว? เข้าสู่ระบบ"; }
            else { btn.innerText = "เข้าสู่ระบบ"; link.innerText = "สมัครสมาชิกใหม่"; }
        };

        document.getElementById('auth-btn').onclick = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(!e || !p) return showToast("กรอกข้อมูลให้ครบ", true);
            try {
                if(isReg) await createUserWithEmailAndPassword(auth, e, p);
                else await signInWithEmailAndPassword(auth, e, p);
            } catch(err) { showToast(err.code, true); }
        };

        document.getElementById('google-btn').onclick = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); }
            catch(err) { showToast("Login Error: " + err.code, true); }
        };

        document.getElementById('logout-btn').onclick = () => signOut(auth);

        document.getElementById('snap-btn').onclick = async () => {
            const l = prompt("สถานที่?");
            const f = prompt("ชั้น?");
            const z = prompt("โซน?");
            if(l) {
                await setDoc(doc(db, `artifacts/park-q-default/users/${user.uid}/parkingStatus/current`), {
                    location: l, floor: f, pillar: z, createdAt: new Date()
                });
            }
        };

        document.getElementById('checkout-btn').onclick = async () => {
            if(confirm("เอารถออกแล้ว?")) {
                await deleteDoc(doc(db, `artifacts/park-q-default/users/${user.uid}/parkingStatus/current`));
            }
        };

        document.getElementById('add-car-btn').onclick = async () => {
            const n = prompt("ชื่อรถ (เช่น น้องขาว)");
            const p = prompt("ทะเบียนรถ");
            if(n && p) {
                await addDoc(collection(db, `artifacts/park-q-default/users/${user.uid}/cars`), {
                    name: n, plate: p, ownerId: user.uid
                });
            }
        };

        document.getElementById('close-modal-btn').onclick = () => document.getElementById('qr-modal').classList.add('hidden');

        // Start App
        init();

    </script>
</body>
</html>
